#!/bin/bash
# EXPECTS CLOUD_TYPE
# EXPECTS SLURM_MAIL

SLURM_SCRIPT_INCLUDE="$(dirname -- "$0")/../include"
export SLURM_SCRIPT_INCLUDE

[ -z "$CLOUD_TYPE" ] && echo "CLOUD_TYPE not set!" && exit 1
[ -z "$SLURM_MAIL" ] && echo "SLURM_MAIL not set!" && exit 1

ARGS=("$@")

UNPROCESSED_ARGS=()

EXTRA_OPTIONS=()

OPTIONS_LENGTH=0
for ARG in "${ARGS[@]}"
do
  case "$ARG" in
    --rtx)
      EXTRA_OPTIONS=("--gres=gpu:rtx:1")
      ((OPTIONS_LENGTH++))
      ;;
    --gpu)
      EXTRA_OPTIONS=("--gres=gpu:1")
      ((OPTIONS_LENGTH++))
      ;;
    --)
      FOUND_DDASH=1
      break
      ;;
    *)
      UNPROCESSED_ARGS+=("$ARG")
      ((OPTIONS_LENGTH++))
      ;;
    esac
done

# REQUIRE a -- not emtpy!
[ -z "$FOUND_DDASH" ] && echo "'--' missing to separate sbatch arguments from experiment arguments!" && exit 1

SCRIPT_ARGS=("${@:$OPTIONS_LENGTH+2}")

if [ "$CLOUD_TYPE" = "arc" ]; then
  : "${SBATCH_CPUS_PER_GPU:=3}"
  : "${SBATCH_PARTITION:=htc-nova}"
  : "${SBATCH_RESERVATION:=ecr_202104}"
  : "${SBATCH_QOS:=ecr}"
elif [ "$CLOUD_TYPE" = "oatcloud" ]; then
  EXTRA_OPTIONS+=("--cpus-per-task=4")
fi

echo SLURM Environment:
env | grep SBATCH

echo sbatch --export=ALL --mail-user "$SLURM_MAIL" "${EXTRA_OPTIONS[@]}" "${UNPROCESSED_ARGS[@]}" -- "$SLURM_SCRIPT_INCLUDE/sbatch_script.sh" "${SCRIPT_ARGS[@]}"
sbatch --export=ALL --mail-user "$SLURM_MAIL" "${EXTRA_OPTIONS[@]}" "${UNPROCESSED_ARGS[@]}" -- "$SLURM_SCRIPT_INCLUDE/sbatch_script.sh" "${SCRIPT_ARGS[@]}"
